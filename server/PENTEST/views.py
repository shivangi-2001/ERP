from django.shortcuts import render
from rest_framework.viewsets import ModelViewSet
from rest_framework import generics, views
from rest_framework.response import Response
from rest_framework.permissions import IsAdminUser, IsAuthenticated
from .models import ClientAssessmentType, URL, Findings, POCS
from .serializer import ClientAssessmentTypeSerializer, URLSerializer, FindingSerializer, POCSerializer
from .pagination import LargeResultsSetPagination, StandardResultsSetPagination
   
class ClientAssessmentTypeViewSet(ModelViewSet):
    queryset = ClientAssessmentType.objects.select_related('assessment_type', 'client').all()
    serializer_class = ClientAssessmentTypeSerializer
    pagination_class = LargeResultsSetPagination
    
    def get_queryset(self):
        queryset = ClientAssessmentType.objects.select_related('assessment_type', 'client').all()
        client_id = self.request.query_params.get('client')
        assessment_type = self.request.query_params.get("assessment_type")
        
        if client_id is not None:
            queryset = queryset.filter(client_id=client_id)
        if assessment_type is not None and assessment_type not in ["" , "null" ,"undefined"]:
            queryset = queryset.filter(assessment_type__name=assessment_type)
            
        return queryset
    
class URLViewset(ModelViewSet):
    queryset = URL.objects.select_related("tester", "client_assessment", "compliance").all()
    serializer_class = URLSerializer
    pagination_class = StandardResultsSetPagination
    
    def get_queryset(self):
        queryset = URL.objects.select_related("tester", "compliance", "client_assessment", "client_assessment__client", "client_assessment__assessment_type").all()
        
        client_detail_id = self.request.query_params.get('client_id') 
        
        assessment_name = self.request.query_params.get('assessment_type') 
        
        if client_detail_id is not None:
            queryset = queryset.filter(client_assessment__client=client_detail_id)
            
        if assessment_name is not None:
            queryset = queryset.filter(client_assessment__assessment_type__name=assessment_name)
            
            
        return queryset
    
    
class InsertManyURL(views.APIView):
    def post(self, request, *args, **kwargs):
        excel_data = request.data.get('data')
        client_assessment_id = self.request.data.get('client_assessment_id')
        if not excel_data:
            return Response({"error": "No data provided"}, status=400)
        
        model_instances = []
        
        for row in excel_data:
            model_instances.append(
                URL(
                    url=row.get('url'), 
                    client_assessment_id=client_assessment_id 
                )
            )
        try:
            URL.objects.bulk_create(model_instances, ignore_conflicts=True)
            return Response({"message": f"Successfully added {len(model_instances)} URLs."})
        except Exception as e:
            return Response({"error": str(e)}, status=500)
    
    
    
class InProgresViews(generics.ListAPIView):
    queryset = URL.objects.filter(is_completed=False, start_date__isnull=False, end_date__isnull=False, qa_date__isnull=False, compliance__isnull=False, tester__isnull=False).select_related('client_assessment', 'tester', 'compliance').all()
    serializer_class = URLSerializer
    pagination_class = LargeResultsSetPagination
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        user = self.request.user
        queryset = URL.objects.filter(is_completed=False, start_date__isnull=False, end_date__isnull=False, qa_date__isnull=False, compliance__isnull=False, tester_id=user.id).prefetch_related('findings').select_related('client_assessment', 'tester', 'compliance').all()
        return queryset

    
class InProgressDetailView(generics.RetrieveAPIView):
    queryset = URL.objects.filter(
        start_date__isnull=False, 
        end_date__isnull=False, 
        qa_date__isnull=False, 
        compliance__isnull=False, 
        tester__isnull=False
    ).select_related('client_assessment', 'tester', 'compliance',)
    
    serializer_class = URLSerializer
    lookup_field = 'pk'
    permission_classes = [IsAuthenticated]
    
    def get_queryset(self):
        user = self.request.user
        queryset = URL.objects.filter(
            start_date__isnull=False, 
            end_date__isnull=False, 
            qa_date__isnull=False, 
            compliance__isnull=False, 
            tester_id=user.id
        ).select_related('client_assessment', 'tester', 'compliance')
        return queryset
    
    
class CompletedPentest(generics.ListAPIView):
    queryset = URL.objects.filter(is_completed=True).select_related('client_assessment', 'tester', 'compliance').all()
    serializer_class = URLSerializer
    pagination_class = StandardResultsSetPagination
    permission_classes = [IsAuthenticated, IsAdminUser]
    
    def get_queryset(self):
        user = self.request.user
        queryset = URL.objects.filter(is_completed=True, tester_id=user.id).select_related('client_assessment', 'tester', 'compliance').all()
        return queryset
    
    
class FindingViewset(ModelViewSet):
    queryset =  Findings.objects.select_related('url', 'vulnerability').all()
    serializer_class = FindingSerializer
    pagination_class = StandardResultsSetPagination
    
    def get_queryset(self):
        queryset = Findings.objects.select_related('url', 'vulnerability').order_by('-cvss_score').all()
        
        project_id = self.request.query_params.get('project_id') 
        
        if project_id is not None:
            queryset = queryset.filter(url__id=project_id)
            
        return queryset
    

class POCViewset(ModelViewSet):
    queryset = POCS.objects.all()
    serializer_class = POCSerializer