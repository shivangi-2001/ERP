from rest_framework import serializers
from drf_extra_fields.fields import Base64ImageField
from .models import ClientAssessmentType, URL, Findings, POCS
from CORE.models import CompilanceType, User, Vulnerabilities
from CORE.serializer import CompilanceSerializer, UserSerializer, VulnerabilitySerializer
 
class ClientAssessmentTypeSerializer(serializers.ModelSerializer):
    client_name = serializers.CharField(source="client.name", read_only=True)
    assessment_type_name = serializers.CharField(source="assessment_type.name", read_only=True)
    class Meta:
        model = ClientAssessmentType
        fields = ['id', 'client', 'client_name', 'assessment_type', 'assessment_type_name']
       
       
class URLSerializer(serializers.ModelSerializer):
    client_assessment = ClientAssessmentTypeSerializer(read_only=True)
    client_assessment_id = serializers.PrimaryKeyRelatedField(source="client_assessment", queryset=ClientAssessmentType.objects.all(), write_only=True)
    
    compliance = CompilanceSerializer(read_only=True)
    compliance_id = serializers.PrimaryKeyRelatedField(source="compliance", queryset=CompilanceType.objects.all(), write_only=True, allow_null=True,required=False)
    
    tester = UserSerializer(read_only=True)
    tester_id = serializers.PrimaryKeyRelatedField(source="tester", queryset=User.objects.all(), write_only=True, allow_null=True, required=False)
    
    # findings = FindingSerializer(read_only=True)
    finding_counts = serializers.IntegerField(source="findings.count", read_only=True)
    
    class Meta:
        model = URL
        fields = ["id", "start_date", "end_date", "qa_date", "url", 
            "client_assessment", "client_assessment_id", "tester","tester_id", 
            "compliance", "compliance_id", "is_completed", "finding_counts"]

class POCSerializer(serializers.ModelSerializer):
    poc_image = Base64ImageField()
    class Meta:
        model = POCS
        fields = ['steps', 'poc_image', 'description', 'finding']


class FindingSerializer(serializers.ModelSerializer):
    url = URLSerializer(read_only=True)
    url_id = serializers.PrimaryKeyRelatedField(source="url", queryset=URL.objects.all(), write_only=True)
    
    vulnerability = VulnerabilitySerializer(read_only=True)
    vulnerability_id = serializers.PrimaryKeyRelatedField(source="vulnerability", queryset=Vulnerabilities.objects.all(), write_only=True)
    
    pocs = POCSerializer(many=True, required=False)
    
    class Meta:
        model = Findings
        fields = ['id', 'url', 'url_id', 'vulnerability', 'vulnerability_id', 'cvss_score', 'pocs']
        
    def validate(self, data):
        url_instance = data.get('url_id')
        vul_instance = data.get('vulnerability_id')
        
        if url_instance and vul_instance:
            assessment_name = url_instance.client_assessment.assessment_type.name
            vuln_category = vul_instance.category_of_testing.name

            if assessment_name != vuln_category:
                raise serializers.ValidationError(
                    f"Mismatch: URL Assessment is '{assessment_name}', "
                    f"but Vulnerability Category is '{vuln_category}'."
                )

        return data
    
    def create(self, validated_data):
        pocs_data = validated_data.pop('pocs', [])
        finding = Findings.objects.create(**validated_data)
        for poc_item in pocs_data:
            POCS.objects.create(finding=finding, **poc_item)
            
        return finding