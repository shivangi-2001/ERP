import { createApi } from "@reduxjs/toolkit/query/react";
import baseAuthHeader from "./baseAuthHeader";
import { ClientAssessment, ClientAssessmentType, URL, URLType, FindingType, Finding } from "../types/pentest";

export const pentestApi = createApi({
    reducerPath: "pentestApi",
    baseQuery: baseAuthHeader,
    tagTypes: ["pentest", "url"],
    endpoints: (builder) => ({
        getClientAssessmentType: builder.query<ClientAssessmentType, {client_id: number, assessment_type: string|null, page: number, pageSize: number}>({
            query:({client_id, assessment_type, page, pageSize}) => `/pentest/client_assessment?client=${client_id}&assessment_type=${assessment_type}&page=${page}&page_size=${pageSize}`,
            providesTags: ["pentest"]
        }),

        createClientAssessmentType: builder.mutation<ClientAssessment, Partial<ClientAssessment>>({
            query:(body) => ({
                url: `/pentest/client_assessment/`,
                method: 'POST',
                body
            }),
            invalidatesTags: ["pentest"]
        }),

        editClientAssessmentType: builder.mutation<ClientAssessment, {id: number, body: Partial<ClientAssessment>}>({
            query:({id, body}) => ({
                url: `/pentest/client_assessment/${id}`,
                method: 'PATCH',
                body
            }),
            invalidatesTags: ["pentest"]
        }),

        deleteClientAssessmentType: builder.mutation<void, string | number>({
            query: (id) => ({
                url: `/pentest/client_assessment/${id}/`,
                method: "DELETE",
            }),
            invalidatesTags: ["pentest"],
        }),



        getUrlMapping: builder.query<URLType, {client_id:number|undefined, assessment_type:string|null,page: number; pageSize: number}>({
            query: ({client_id, assessment_type, page, pageSize}) => `/pentest/url/?client_id=${client_id}&assessment_type=${assessment_type}&page=${page}&page_size=${pageSize}`,
            providesTags: ["url"],
        }),

        createUrlMapping: builder.mutation<URL, Partial<URL>>({
            query: (body) => ({
                url: "/pentest/url/",
                method: "POST",
                body,
            }),
            invalidatesTags: ["url"],
        }),

        insertURLMapping: builder.mutation<{message: string}, { client_assessment_id: Number, data: any[]}>({
            query:(body) => ({
                url: `/pentest/urls/upload/`,
                method: 'POST',
                body,
            })
        }),

        getUrlMappingByID: builder.query<URL, { id: number }>({
            query: ({id}) => `/pentest/url/${id}/`,
            providesTags: ["url"],
        }),

        editUrlMappingByID: builder.mutation<URL, {id: number, body: Partial<URL>}>({
            query: ({id, body}) => ({
                url: `/pentest/url/${id}/`,
                method: "PATCH",
                body,
            }),
            invalidatesTags: ["url"],
        }),


        getInProgressProject: builder.query<URLType, {page: number, pageSize: number}>({
            query: ({page, pageSize}) => `/pentest/in-progress/?page=${page}&pageSize=${pageSize}`
        }),
        
        getInProgressProjectById: builder.query<URL, {pk: number}>({
            query: ({pk}) => `/pentest/in-progress/${pk}`
        }),



        getFindingsByProjectID: builder.query<FindingType, {project_id:number, page: number, pageSize: number}>({
            query:({project_id, page, pageSize}) => `/pentest/findings/?project_id=${project_id}&page=${page}&pageSize=${pageSize}`
        }),

        createFindingByProjectID: builder.mutation<void, Partial<Finding>>({
            query:(body) => ({
                url: `/pentest/findings/`,
                method: 'POST',
                body,
            })
        }),

        deleteFinding: builder.mutation<void, {id: number}>({
            query:(id) =>  ({
                url: `/pentest/findings/${id}/`,
                method: "DELETE"
            })

        }),

        getCompletedPentest: builder.query<URLType, {page: number, pageSize: number}>({
            query: ({page, pageSize}) => `/pentest/completed?page=${page}&pageSize=${pageSize}`
        }),

    })
});

export const {
    useGetClientAssessmentTypeQuery,
    useCreateClientAssessmentTypeMutation,
    useEditClientAssessmentTypeMutation,
    useDeleteClientAssessmentTypeMutation,

    useGetUrlMappingQuery,
    useCreateUrlMappingMutation,
    useInsertURLMappingMutation,
    useGetUrlMappingByIDQuery,
    useEditUrlMappingByIDMutation,

    useGetInProgressProjectQuery,
    useGetInProgressProjectByIdQuery,

    useGetFindingsByProjectIDQuery,
    useCreateFindingByProjectIDMutation,
    useDeleteFindingMutation,

    useGetCompletedPentestQuery
} = pentestApi;