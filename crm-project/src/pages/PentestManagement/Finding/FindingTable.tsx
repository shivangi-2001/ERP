import { useDispatch, useSelector } from "react-redux";
import { useParams } from "react-router";
import TableOutlet from "../../../components/common/TableOutlet";
import { Table, TableBody, TableCell, TableHeader, TableRow, } from "../../../components/ui/table";
import { RootState } from "../../../app/store";
import { TrashBinIcon } from "../../../icons";
import { setCurrentPage, setFinding, setRowsPerPage } from "../../../features/pentest";
import { useGetFindingsByProjectIDQuery } from "../../../service/pentest";
import { useDeleteFindingMutation } from "../../../service/pentest";
import { useState } from "react";
import Alert from "../../../components/ui/alert/Alert";
import { useModal } from "../../../hooks/useModal";
import { Modal } from "../../../components/ui/modal";
import ViewFinding from "./ViewFinding";

const FindingTable = () => {
  const dispatch = useDispatch();
  const { id } = useParams();
  const { isOpen, closeModal, openModal} = useModal();
  const [status, setStatus] = useState<{ type: "success" | "error"; message: string } | null>(null);

  const { rowperpage, currentpage, url, finding } = useSelector(
    (state: RootState) => state.pentest
  );

  const { data: findings, isLoading, refetch } = useGetFindingsByProjectIDQuery({
    project_id: url?.id || Number(id),
    page: currentpage,
    pageSize: rowperpage,
  });

  const [deleteFinding] = useDeleteFindingMutation();

  const totalRows = findings?.count || 0;
  const IndexofFirstItem = (currentpage - 1) * rowperpage + 1;
  const IndexofLastItem = Math.min(currentpage * rowperpage, totalRows);

  const cvss_color = [
    "text-emerald-600", // 0: Low
    "text-yellow-600",  // 1: Medium
    "text-orange-500",  // 2: High
    "text-red-600"      // 3: Critical
  ];

  const getCvssColor = (text: string | undefined) => {
    if (!text) return "text-gray-500";
    
    const lowerText = text.toLowerCase();
    
    if (lowerText.includes("critical")) return cvss_color[3];
    if (lowerText.includes("high")) return cvss_color[2];
    if (lowerText.includes("medium")) return cvss_color[1];
    if (lowerText.includes("low")) return cvss_color[0];
    
    return "text-gray-500";
  };

    const handleDelete = async (item: any) => {
      console.log(item)
      try {
        await deleteFinding(item.id).unwrap();
        
        setStatus({
          type: "success",
          message: `finding is as deleted successfully.`
        });
  
        refetch();
      } catch (error) {
        console.error(error);
        setStatus({
          type: "error",
          message: "Failed to delete finding, Please try again."
        });
      }
    };

  return (
    <TableOutlet
      title="List of findings"
      pageSizeOptions={[10, 20, 25, 30]}
      rowsPerPage={rowperpage}
      setRowsPerPage={(rows) => dispatch(setRowsPerPage(rows))}
      totalRows={totalRows}
      currentPage={currentpage}
      onPageChange={(page) => dispatch(setCurrentPage(page))}
      indexOfFirstItem={IndexofFirstItem}
      indexOfLastItem={IndexofLastItem}
    >
      {status && (
        <div className="mb-4 p-5">
          <Alert
            variant={status.type}
            title={status.type === "success" ? "Success" : "Error"}
            message={status.message}
          />
        </div>
      )}

      <Modal isOpen={isOpen} onClose={closeModal}>
       <ViewFinding />
      </Modal>

      <Table>
        <TableHeader className="border-b border-gray-100 dark:border-white/[0.05]">
          <TableRow>
            <TableCell
              isHeader
              className="px-5 py-3 font-medium text-gray-500 text-start text-theme-xs dark:text-gray-400"
            >
              Vulnerability Name
            </TableCell>
            
            <TableCell
              isHeader
              className="px-5 py-3 font-medium text-gray-500 text-start text-theme-xs dark:text-gray-400"
            >
              Action
            </TableCell>
          </TableRow>
        </TableHeader>

        <TableBody className="divide-y divide-gray-100 dark:divide-white/[0.05]">
          {findings?.results && findings.results.length > 0 ? (
            findings.results.map((finding) => (
              <TableRow
                key={finding.id}
                className={`cursor-pointer 
                          hover:bg-gray-100 dark:bg-gray-900
                           text-sm  dark:hover:bg-white/[0.03] transition-colors`}
                onClick={() => {
                  dispatch(setFinding(finding))
                  openModal()
                }}
              >
                <TableCell className="px-5 py-4 sm:px-6 text-start">
                  <span className="block font-medium text-gray-600 text-theme-sm dark:text-white/90">
                    {finding.vulnerability?.name}
                  </span>
                  {/* Applied the color function here */}
                  <span className={`${getCvssColor(finding.cvss_score)} block font-medium select-none text-theme-xs mt-1`}>
                     {finding.cvss_score}
                  </span>
                </TableCell>

               

                <TableCell className="px-4 py-3 text-gray-500 text-start text-theme-sm dark:text-gray-400">
                  <div className="flex gap-3" onClick={()=>handleDelete(finding)}>
                    <TrashBinIcon className="size-5 cursor-pointer text-red-500 hover:text-red-800" />
                  </div>
                </TableCell>
              </TableRow>
            ))
          ) : (
            <TableRow>
              <TableCell className="px-5 py-4 text-center select-none text-gray-500">
                No findings are added yet
              </TableCell>
            </TableRow>
          )}
        </TableBody>
      </Table>
    </TableOutlet>
  );
};

export default FindingTable;