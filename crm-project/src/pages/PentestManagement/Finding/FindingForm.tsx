import { useState, useEffect, useMemo } from "react";
import { useDispatch, useSelector } from "react-redux";
import Card from "../../../components/common/Card";
import Form from "../../../components/form/Form";
import Input from "../../../components/form/input/InputField";
import Label from "../../../components/form/Label";
import Alert from "../../../components/ui/alert/Alert";
import { Modal } from "../../../components/ui/modal";
import Select from "../../../components/form/Select";
import TextArea from "../../../components/form/input/TextArea";
import { CalenderIcon, PlusIcon } from "../../../icons";
import { useModal } from "../../../hooks/useModal";
import { RootState } from "../../../app/store";
import { Vulnerability } from "../../../types/assessment";
import { useSearchVulnerabilityQuery } from "../../../service/assessment";
import CVSS from "../../AssestManagement/CVSS/Index";
import Button from "../../../components/ui/button/Button";
import { useCreateFindingByProjectIDMutation, useGetInProgressProjectByIdQuery } from "../../../service/pentest";
import { useNavigate, useParams } from "react-router";
import { setURL } from "../../../features/pentest";
import POCForm from "../POC/Form";
import Badge from "../../../components/ui/badge/Badge";
import POCTable from "../POC/Table";

const FindingForm = () => {
  const { id } = useParams();
  const navigate = useNavigate();
  const dispatch = useDispatch();
  const { isOpen, closeModal, toggleModal } = useModal();
  const { isOpen: OpenPOC, closeModal: closeModalPOC, openModal: openModalPOC} = useModal();

  const {data: InProgressById} = useGetInProgressProjectByIdQuery({pk:Number(id)});

  useEffect(() => {
    if(InProgressById) dispatch(setURL(InProgressById))
  }, [InProgressById, dispatch])

  // Redux Selectors
  const { baseScore, severity } = useSelector((state: RootState) => state.cvss);
  const { assessment_types } = useSelector((state: RootState) => state.assessment);
  const { url, pocs } = useSelector((state: RootState) => state.pentest);

  // Form State
  const initialFormState: Partial<Vulnerability> = {
    id: 0,
    name: "",
    description: "",
    impact: "",
    reference: "",
    remediations: "",
    cvss: "",
    category_of_testing_id: 0,
  };
  
  const [formData, setFormData] = useState<Partial<Vulnerability>>(initialFormState);
  const [statusMessage, setStatusMessage] = useState<{ type: "success" | "error"; text: string } | null>(null);
  const [errors, setErrors] = useState<any>({});

  const [searchValue, setSearchValue] = useState<string>("");
  const [debouncedSearchValue, setDebouncedSearchValue] = useState<string>("");

  useEffect(() => {
    const handler = setTimeout(() => {
      setDebouncedSearchValue(searchValue);
    }, 200);

    return () => {
      clearTimeout(handler);
    };
  }, [searchValue]);

  useEffect(() => {
    if (baseScore && severity) {
      setFormData((prev) => ({
        ...prev,
        cvss: `${baseScore} (${severity})`,
      }));
    }
  }, [baseScore, severity]);

  const handleChange = (field: keyof Vulnerability, value: any) => {
    setFormData((prev) => ({ ...prev, [field]: value }));
    if (errors[field]) {
      setErrors((prev: any) => ({ ...prev, [field]: undefined }));
    }
  };

  const { data: searchVulnerability } = useSearchVulnerabilityQuery({
    assessment_type: url?.client_assessment?.assessment_type_name,
    search_text: debouncedSearchValue
  }, { 
    skip: !debouncedSearchValue || debouncedSearchValue.length < 2 
  });

  const searchOption = useMemo(() => {
    return searchVulnerability?.results?.map((search: any) => ({
      label: search.name,
      value: search.id
    })) || [];
  }, [searchVulnerability]);


  const handleSearchSelect = (selectedItem: any) => {
    const selectedVuln = searchVulnerability?.results.find((v: any) => v.id === selectedItem.value);
    
    if (selectedVuln) {
      setFormData({
        id: selectedVuln.id,
        name: selectedVuln.name,
        description: selectedVuln.description,
        impact: selectedVuln.impact,
        remediations: selectedVuln.remediations,
        reference: selectedVuln.reference,
        cvss: selectedVuln.cvss,
        category_of_testing_id: selectedVuln.category_of_testing_id || 0,
      });
      // Clear search after selection
      setSearchValue(""); 
    }
  };

  const [createFinding, {isLoading}] = useCreateFindingByProjectIDMutation()

  const handleSubmit = async (e:React.FormEvent) => {
    e.preventDefault();

    if(!formData.id || !formData.cvss || !formData.cvss || !url?.id){
      setStatusMessage({type:"error", text: "Please all fields are required."})
    }
    try {
      const body = {url_id: url?.id, vulnerability_id: formData.id, cvss_score: formData.cvss, pocs: pocs || []}
      console.log(body)
      await createFinding(body).unwrap()
      setStatusMessage({ type: "success", text: "Successfully added findings."})
      setErrors({});
      // navigate(0);
    } catch (error: any) {
      console.log(error)
      const globalMsg = error?.data?.detail || error?.data?.non_field_errors?.[0] || "Failed to add findings.";
      setStatusMessage({ type: "error", text: globalMsg });
      setErrors(error.data);
    }
  }

  return (
    <Card 
      title="Add Findings"
      desc={`Add findings & pocs in `} 
      enableSearch={true}
      searchValue={searchValue}
      searchResults={searchOption}
      onSearchChange={(e: any) => setSearchValue(e.target.value)}
      onSearchSelect={handleSearchSelect}
    >
      
      {statusMessage && (
        <div className="mb-4 p-5">
          <Alert
            variant={statusMessage.type}
            title={statusMessage.type === "success" ? "Success" : "Error"}
            message={statusMessage.text}
          />
        </div>
      )}

      {/* CVSS Calculator Modal */}
      <Modal isOpen={isOpen} onClose={closeModal}>
        <CVSS />
      </Modal>

      <Form onSubmit={handleSubmit} className="p-5">
        <div className="flex flex-col gap-5">
          {/* Inputs Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <Label htmlFor="name">
                Vulnerability Name <span className="text-red-500">*</span>
              </Label>
              <Input
                type="text"
                id="name"
                onChange={(e) => handleChange("name", e.target.value)}
                value={formData.name || ""}
                placeholder="e.g. SQL Injection"
                error={!!errors.name}
                hint={errors.name}
              />
            </div>

            <div>
              <Label htmlFor="cvss">CVSS Score</Label>
              <div className="relative">
                <Input
                  type="text"
                  id="cvss"
                  className="pl-12"
                  onChange={(e) => handleChange("cvss", e.target.value)}
                  value={formData.cvss || ""}
                  placeholder="e.g. 9.8 (Critical)"
                  error={!!errors.cvss||!!errors.cvss_score}
                  hint={errors.cvss||errors.cvss_score}
                />
                <span
                  onClick={toggleModal}
                  className="absolute left-0 top-0 h-11 w-11 flex items-center justify-center border-r border-gray-200 text-gray-500 cursor-pointer hover:bg-gray-50 dark:border-gray-800 dark:text-gray-400 dark:hover:bg-white/5"
                  title="Open CVSS Calculator"
                >
                  <CalenderIcon className="size-5 text-theme-sm" />
                </span>
              </div>
            </div>
          </div>

          {/* Rest of the form fields... */}
          <div>
            <Label htmlFor="category_of_testing_id">
              Category of Testing <span className="text-red-500">*</span>
            </Label>
            <Select
              options={assessment_types || []}
              placeholder="Select category"
              onChange={(val) => handleChange("category_of_testing_id", Number(val))}
              defaultValue={url?.client_assessment?.assessment_type}
              disabled={false}
            />
          </div>
          
          <div>
            <Label htmlFor="description">Description</Label>
            <TextArea
              id="description"
              onChange={(val) => handleChange("description", val)}
              value={formData.description || ""}
              placeholder="Detailed description..."
              error={!!errors.description}
              hint={errors.description}
              rows={4}
            />
          </div>

          <div>
            <Label htmlFor="impact">Impact</Label>
            <TextArea
              id="impact"
              onChange={(val) => handleChange("impact", val)}
              value={formData.impact || ""}
              placeholder="Business impact..."
              error={!!errors.impact}
              hint={errors.impact}
              rows={3}
            />
          </div>

          <div>
            <Label htmlFor="remediation">Remediations</Label>
            <TextArea
              id="remediations"
              onChange={(val) => handleChange("remediations", val)}
              value={formData.remediations || ""}
              placeholder="Steps to fix..."
              error={!!errors.remediations}
              hint={errors.remediations}
              rows={3}
            />
          </div>

          <div>
            <Label htmlFor="reference">References</Label>
            <TextArea
              id="reference"
              onChange={(val) => handleChange("reference", val)}
              value={formData.reference || ""}
              placeholder="Links to CVEs..."
              error={!!errors.reference}
              hint={errors.reference}
              rows={2}
            />
          </div>

          <Badge color="info" variant="light" onClick={openModalPOC} ><PlusIcon className="size-5" />POC</Badge>
        
          <POCTable data={pocs} isViewOnly={false} />
        
        </div>
        <div className="flex flex-row-reverse gap-5 mt-10 border-t pt-4">
           <Button>Add Finding</Button>
        </div>
      </Form>

      <Modal isOpen={OpenPOC} onClose={closeModalPOC}>
        <POCForm />
        
      </Modal>
    </Card>
  );
};

export default FindingForm;