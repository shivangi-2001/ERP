import { useDispatch } from "react-redux";
import {
  Table,
  TableCell,
  TableHeader,
  TableRow,
  TableBody,
} from "../../../components/ui/table";
import { TrashBinIcon } from "../../../icons";
import { removePOC } from "../../../features/pentest";
import { POC } from "../../../types/pentest";
import { getPocImageUrl } from "../../../utils/image";

const TableTitle = ["steps", "image", "description", "action"];

interface POCTableProps {
  data?: POC[]; // Data passed from a "View" component
  isViewOnly?: boolean;
}

const POCTable = ({ data, isViewOnly = false }: POCTableProps) => {
  const dispatch = useDispatch();

  const handleDelete = (steps: number) => {
    if (!isViewOnly && steps > 0) {
      dispatch(removePOC(steps));
    }
  };

  return (
    <Table>
      <TableHeader className="border-b border-gray-100 dark:border-white/[0.05]">
        <TableRow>
          {TableTitle.map((title) => (
            <TableCell
              key={title}
              isHeader
              className="px-5 py-3 font-medium text-gray-500 text-start text-theme-xs dark:text-gray-400"
            >
              {title}
            </TableCell>
          ))}
        </TableRow>
      </TableHeader>

      <TableBody className="divide-y divide-gray-100 dark:divide-white/[0.05]">
        {data?.length === 0 ? (
          <TableRow>
            <TableCell className="px-5 py-4 text-center text-gray-500">
              No POCs available
            </TableCell>
          </TableRow>
        ) : (
          data?.map((poc, index) => (
            <TableRow
              key={index}
              className="text-sm transition-colors hover:bg-gray-100 dark:bg-gray-900 dark:hover:bg-white/[0.03]"
            >
              <TableCell className="px-5 py-4 text-start font-medium text-gray-600 dark:text-white/90">
                {poc.steps}
              </TableCell>
              <TableCell className="px-5 py-4 sm:px-6 text-start">
                <div className="size-20 overflow-hidden rounded border border-gray-200 dark:border-gray-800">
                  <img
                    src={getPocImageUrl(poc.poc_image)}
                    alt={`Step ${poc.steps}`}
                    className="h-full w-full object-cover"
                    onError={(e) => {
                      // Fallback for broken links
                      (e.target as HTMLImageElement).src =
                        "https://placehold.co/80x80?text=Error";
                    }}
                  />
                </div>
              </TableCell>
              <TableCell className="px-5 py-4 text-start text-gray-600 dark:text-white/90">
                {poc.description}
              </TableCell>
              <TableCell className="px-4 py-3 text-start">
                {!isViewOnly && (
                  <div onClick={() => handleDelete(poc.steps)}>
                    <TrashBinIcon className="size-5 cursor-pointer text-red-500 hover:text-red-800" />
                  </div>
                )}
              </TableCell>
            </TableRow>
          ))
        )}
      </TableBody>
    </Table>
  );
};

export default POCTable;
